---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import { floridaCities } from "../../../../data/fl-cities.js";
import fs from "node:fs";
import path from "node:path";

export function getStaticPaths() {
  return floridaCities.map((city) => ({
    params: { city: city.toLowerCase().trim().replace(/\s+/g, "-") },
    props: { city },
  }));
}

const { city } = Astro.props;
const state = "Florida";
const service = "HVAC";

const slug = city.toLowerCase().trim().replace(/\s+/g, "-");
const filePath = path.join(process.cwd(), "src", "data", "fl-hvac", `${slug}.json`);

let listings = [];
if (fs.existsSync(filePath)) {
  try {
    listings = JSON.parse(fs.readFileSync(filePath, "utf-8"));
  } catch {
    listings = [];
  }
}

const updatedHint = listings.length ? "Updated recently" : "Waiting for data";

// Helpers
const cleanTel = (s = "") => s.replace(/[^\d+]/g, "");
const ratingNum = (b) => (typeof b.rating === "number" ? b.rating : 0);
const reviewsNum = (b) => (typeof b.reviews === "number" ? b.reviews : 0);
const hasWebsite = (b) => Boolean(b.website);

// allow maps fallback if present in your JSON
const mapsLink = (b) => b.maps || b.googleMapsUri || b.google_maps || null;
const primaryLink = (b) => b.website || mapsLink(b) || null;

// Recommended score
const scoreOf = (b) =>
  (ratingNum(b) * 100) +
  Math.min(90, Math.sqrt(reviewsNum(b)) * 7) +
  (hasWebsite(b) ? 18 : 0);

// Featured = top 3 by score with reasonable rating
const featured = [...listings]
  .filter((b) => primaryLink(b) && ratingNum(b) >= 4.2)
  .sort((a, b) => scoreOf(b) - scoreOf(a))
  .slice(0, 3);

const featuredKeys = new Set(
  featured.map((b) => `${(b.name || "").toLowerCase()}|${(b.address || "").toLowerCase()}`)
);

const mainListings = [...listings]
  .filter((b) => {
    const key = `${(b.name || "").toLowerCase()}|${(b.address || "").toLowerCase()}`;
    return !featuredKeys.has(key);
  })
  .sort((a, b) => scoreOf(b) - scoreOf(a)); // initial = recommended

const withWebsiteCount = listings.filter((b) => hasWebsite(b)).length;
const withPhoneCount = listings.filter((b) => Boolean(b.phone)).length;

const websiteLabelChip = (biz) => (biz.website ? null : "No website");
---

<BaseLayout
  title={`${service} in ${city}, ${state} | FixAlways`}
  description={`Browse HVAC companies in ${city}, Florida. Ratings, reviews, phone numbers, and websites.`}
  badge={`${state} ‚Ä¢ ${service}`}
>
  <!-- Hero with right accent (Option B) -->
  <section class="hero">
    <div class="heroMedia">
      <img class="heroBase" src="/assets/hero/desktop.webp" alt="" aria-hidden="true" />

      <picture>
        <source srcset="/assets/hero/accent-right.webp" type="image/webp" />
        <img class="heroAccentRight" src="/assets/hero/accent-right.png" alt="" aria-hidden="true" loading="lazy" />
      </picture>

      <img class="heroOverlaySvg" src="/assets/hero/hero-overlay.svg" alt="" aria-hidden="true" loading="lazy" />
      <div class="heroOverlay" aria-hidden="true"></div>

      <div class="heroPanel">
        <div class="heroEyebrow">{state} ‚Ä¢ {service}</div>
        <h1>{service} in {city}, {state}</h1>
        <p>
          Real listings pulled from Google Places. <span style="color: rgba(255,255,255,.72);">{updatedHint}</span>
        </p>

        <div style="margin-top: 10px; color: rgba(255,255,255,.72); font-size: 13px;">
          <strong style="color: rgba(255,255,255,.92);">{listings.length}</strong> total ‚Ä¢
          <strong style="color: rgba(255,255,255,.92);"> {withPhoneCount}</strong> with phone ‚Ä¢
          <strong style="color: rgba(255,255,255,.92);"> {withWebsiteCount}</strong> with website
        </div>

        <div style="margin-top: 12px;">
          <a class="btn" href="/">‚Üê Back to cities</a>
        </div>
      </div>
    </div>
  </section>

  <div class="grid">
    <!-- ‚úÖ Featured companies section -->
    {featured.length > 0 ? (
      <section class="card">
        <div class="cardHeader">
          <h2>Top rated picks</h2>
          <div class="meta">Best overall signals</div>
        </div>

        <ul class="list">
          {featured.map((biz) => {
            const tel = biz.phone ? cleanTel(biz.phone) : "";
            const link = primaryLink(biz);
            const maps = mapsLink(biz);
            const noWebsite = !biz.website;

            return (
              <li class="item">
                <div class="left">
                  <div class="nameRow">
                    {link ? (
                      <a class="nameLink" href={link} target="_blank" rel="noopener noreferrer">
                        <span class="name">{biz.name}</span>
                      </a>
                    ) : (
                      <span class="name">{biz.name}</span>
                    )}

                    {link ? (
                      <a class="openIcon" href={link} target="_blank" rel="noopener noreferrer" aria-label="Open listing">
                        ‚Üó
                      </a>
                    ) : null}
                  </div>

                  <div class="sub">
                    ‚≠ê {biz.rating ?? "‚Äî"} ({biz.reviews ?? "‚Äî"} reviews)
                    <br />
                    {biz.address ?? ""}
                    <br />
                    üìû {biz.phone ?? "‚Äî"}
                  </div>
                </div>

                <div class="right">
                  <div class="metaChips">
                    <span class="metaChip">‚≠ê <strong>{biz.rating ?? "‚Äî"}</strong></span>
                    <span class="metaChip">{biz.reviews ?? "‚Äî"} reviews</span>
                    {noWebsite ? <span class="metaChip">No website</span> : null}
                  </div>

                  <div class="btnRow">
                    {tel ? <a class="btn btnPrimary" href={`tel:${tel}`}>Call</a> : null}

                    {/* ‚úÖ Website button ONLY if website exists */}
                    {biz.website ? (
                      <a class="btn" href={biz.website} target="_blank" rel="noopener noreferrer">
                        Website
                      </a>
                    ) : null}

                    {/* ‚úÖ Directions only if no website and maps exists */}
                    {!biz.website && maps ? (
                      <a class="btn" href={maps} target="_blank" rel="noopener noreferrer">
                        Directions
                      </a>
                    ) : null}
                  </div>
                </div>
              </li>
            );
          })}
        </ul>
      </section>
    ) : null}

    <!-- Filters / sorting -->
    <section class="card">
      <div class="cardHeader">
        <h2>Refine results</h2>
        <div class="meta">Sort & filters</div>
      </div>

      <div style="padding: 14px 16px;">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <label style="display:flex; gap:8px; align-items:center; color: rgba(255,255,255,.75); font-size: 13px;">
            <span>Sort:</span>
            <select id="sortSelect" class="input select" style="max-width: 240px;">
              <option value="recommended">Recommended</option>
              <option value="rating">Highest rating</option>
              <option value="reviews">Most reviews</option>
              <option value="name">Name (A‚ÄìZ)</option>
            </select>
          </label>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <button class="chip" id="filterRating45" type="button" aria-pressed="false">4.5+ rating</button>
            <button class="chip" id="filterReviews100" type="button" aria-pressed="false">100+ reviews</button>
            <button class="chip" id="filterWebsite" type="button" aria-pressed="false">Has website</button>
          </div>
        </div>

        <div style="margin-top:10px; color: rgba(255,255,255,.65); font-size: 12px;">
          Tip: use the header search to filter this list.
        </div>
      </div>
    </section>

    <!-- Main list -->
    <section class="card">
      <div class="cardHeader">
        <h2>Local companies</h2>
        <div class="meta" id="resultsMeta">
          {mainListings.length ? `${mainListings.length} found` : "No results yet"}
        </div>
      </div>

      {mainListings.length > 0 ? (
        <ul class="list" id="listingList">
          {mainListings.map((biz) => {
            const tel = biz.phone ? cleanTel(biz.phone) : "";
            const link = primaryLink(biz);
            const maps = mapsLink(biz);
            const noWebsite = !biz.website;

            const rating = biz.rating ?? "";
            const reviews = biz.reviews ?? "";

            return (
              <li
                class="item listingItem"
                data-name={(biz.name ?? "").toLowerCase()}
                data-rating={rating}
                data-reviews={reviews}
                data-website={biz.website ? "1" : "0"}
              >
                <div class="left">
                  <div class="nameRow">
                    {link ? (
                      <a class="nameLink" href={link} target="_blank" rel="noopener noreferrer">
                        <span class="name">{biz.name}</span>
                      </a>
                    ) : (
                      <span class="name">{biz.name}</span>
                    )}

                    {link ? (
                      <a class="openIcon" href={link} target="_blank" rel="noopener noreferrer" aria-label="Open listing">
                        ‚Üó
                      </a>
                    ) : null}
                  </div>

                  <div class="sub">
                    ‚≠ê {biz.rating ?? "‚Äî"} ({biz.reviews ?? "‚Äî"} reviews)
                    <br />
                    {biz.address ?? ""}
                    <br />
                    üìû {biz.phone ?? "‚Äî"}
                  </div>
                </div>

                <div class="right">
                  <div class="metaChips">
                    <span class="metaChip">‚≠ê <strong>{biz.rating ?? "‚Äî"}</strong></span>
                    <span class="metaChip">{biz.reviews ?? "‚Äî"} reviews</span>
                    {noWebsite ? <span class="metaChip">No website</span> : null}
                  </div>

                  <div class="btnRow">
                    {tel ? <a class="btn btnPrimary" href={`tel:${tel}`}>Call</a> : null}

                    {biz.website ? (
                      <a class="btn" href={biz.website} target="_blank" rel="noopener noreferrer">
                        Website
                      </a>
                    ) : null}

                    {!biz.website && maps ? (
                      <a class="btn" href={maps} target="_blank" rel="noopener noreferrer">
                        Directions
                      </a>
                    ) : null}
                  </div>
                </div>
              </li>
            );
          })}
        </ul>
      ) : (
        <div style="padding: 16px;">
          <p><strong>Listings are coming soon.</strong></p>
          <p class="sub" style="margin: 0;">
            Run the batch fetch script to populate this city, then refresh this page.
          </p>
        </div>
      )}
    </section>
  </div>

  <!-- Load working filters JS -->
  <script src="/js/city-filters.js" defer></script>
</BaseLayout>
