---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import { services, getServiceByKey, defaultServiceKey } from "../../../../data/services.js";
import { floridaCities } from "../../../../data/fl-cities.js";

/** Build-time: pre-render all city/service routes */
export async function getStaticPaths() {
  const paths = [];

  for (const cityName of floridaCities) {
    const citySlug = cityName
      .toLowerCase()
      .trim()
      .replace(/\s+/g, "-")
      .replace(/[^a-z0-9-]/g, "");

    for (const svc of services) {
      paths.push({ params: { city: citySlug, service: svc.key } });
    }
  }

  return paths;
}

const { city, service } = Astro.params;

const serviceKey = service || defaultServiceKey;
const serviceConfig = getServiceByKey(serviceKey);

if (!serviceConfig) {
  return Astro.redirect(`/fl/${city}/${defaultServiceKey}`);
}

const cityTitle = city
  ? city.replace(/-/g, " ").replace(/\b\w/g, (m) => m.toUpperCase())
  : "City";

/** Load JSON at build time */
const dataModules = import.meta.glob("../../../../data/fl/*/*.json", { eager: true });
const dataKey = `../../../../data/fl/${serviceConfig.folder}/${city}.json`;
const mod = dataModules[dataKey];

let listingsRaw = [];
let dataFound = true;

if (mod) {
  listingsRaw = mod?.default || mod || [];
} else {
  listingsRaw = [];
  dataFound = false;
}

const listings = (listingsRaw || []).map((x) => ({
  name: x?.name || "",
  rating: Number(x?.rating || 0),
  reviews: Number(x?.reviews || x?.user_ratings_total || 0),
  address: x?.address || x?.vicinity || "",
  website: x?.website || "",
  phone: x?.phone || x?.formatted_phone_number || "",
}));

const serviceLabel = serviceConfig.label;
const pageTitle = `${cityTitle} ${serviceLabel} Listings | FixAlways`;
const pageDesc = `Top rated ${serviceLabel.toLowerCase()} companies in ${cityTitle}. Compare reviews, websites and phone numbers.`;

const currentQueryString = Astro.url.searchParams.toString();
const qs = currentQueryString ? `?${currentQueryString}` : "";

const relatedTrades = services.filter((s) => s.key !== serviceKey).slice(0, 6);
---

<BaseLayout title={pageTitle} description={pageDesc} badge={`Florida • ${serviceLabel}`}>
  <section class="section sectionTight">
    <div class="pageHeader">
      <div>
        <div class="crumbs">
          <a class="crumbLink" href="/">Home</a>
          <span class="crumbSep">/</span>
          <a class="crumbLink" href="/#cities">Florida</a>
          <span class="crumbSep">/</span>
          <span>{cityTitle}</span>
          <span class="crumbSep">/</span>
          <span>{serviceLabel}</span>
        </div>

        <h1 class="pageTitle">{cityTitle} {serviceLabel} listings</h1>
        <p class="pageSubtitle">
          Compare local companies by rating, reviews, and contact info.
        </p>

        <div class="tradeTabsWrap">
          <div class="tradeTabs" role="navigation" aria-label="Trades">
            {services.map((s) => {
              const isActive = s.key === serviceKey;
              const href = `/fl/${city}/${s.key}${qs}`;

              return (
                <a
                  class={`tradeTab ${isActive ? "isActive" : ""}`}
                  href={href}
                  aria-current={isActive ? "page" : undefined}
                >
                  {s.label}
                </a>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section sectionSplit listingsWrap">
    <div class="splitLeft">
      <div class="toolbar card">
        <div class="toolbarRow">
          <div class="toolbarLeft">
            <div class="meta">{listings.length} found</div>

            <div class="toolbarLabel">Sort</div>
            <select id="sortSelect" class="select">
              <option value="recommended" selected>Recommended</option>
              <option value="rating">Rating</option>
              <option value="reviews">Reviews</option>
              <option value="name">Name</option>
            </select>
          </div>

          <div class="toolbarRight">
            <button id="filterRating45" class="chip" type="button">4.5+ rating</button>
            <button id="filterReviews100" class="chip" type="button">100+ reviews</button>
            <button id="filterWebsite" class="chip" type="button">Has website</button>
          </div>
        </div>
      </div>

      {listings.length ? (
        <ul class="listingList" id="listingList">
          {listings.map((x) => (
            <li
              class="listingItem"
              data-name={x.name}
              data-rating={x.rating}
              data-reviews={x.reviews}
              data-website={x.website ? "1" : "0"}
            >
              <div class="listingTop">
                <div class="listingInfo">
                  <div class="listingName">{x.name}</div>

                  <div class="listingMeta">
                    <span class="stars">{x.rating ? x.rating.toFixed(1) : "—"}</span>
                    <span class="dot">•</span>
                    <span>{x.reviews || 0} reviews</span>
                    {x.website && (
                      <>
                        <span class="dot">•</span>
                        <span class="pill">Website</span>
                      </>
                    )}
                  </div>

                  <div class="listingAddr">{x.address}</div>
                </div>

                <div class="listingActions">
                  {x.phone && (
                    <a class="btn btnSmall btnPrimary" href={`tel:${String(x.phone).replace(/\D/g, "")}`}>
                      Call
                    </a>
                  )}
                  {x.website && (
                    <a class="btn btnSmall btnGhost" href={x.website} target="_blank" rel="noopener noreferrer">
                      Website
                    </a>
                  )}
                </div>
              </div>

              <div class="listingBottom">
                <a class="link" href="#">Claim this listing</a>
              </div>
            </li>
          ))}
        </ul>
      ) : (
        <div class="card" style="padding: 16px;">
          <div class="meta">
            {dataFound ? "No listings found yet." : "Service data not added yet."}
          </div>
        </div>
      )}
    </div>

    <aside class="splitRight">
      <div class="panel sticky">
        <div class="panelHeader">
          <div class="panelTitle">Other trades in {cityTitle}</div>
          <div class="panelSubtitle">Switch without losing your filters</div>
        </div>

        <div class="relatedTrades">
          {relatedTrades.map((s) => (
            <a class="relatedTrade" href={`/fl/${city}/${s.key}${qs}`}>
              <span class="relatedTradeName">{s.label}</span>
              <span class="relatedTradeArrow">→</span>
            </a>
          ))}
        </div>
      </div>

      <div class="adBox">
        <div class="adLabel">Sponsored</div>
        <div class="adBody">Future featured placement</div>
      </div>
    </aside>
  </section>

  <script type="module" src="/js/city-filters.js"></script>
</BaseLayout>
